name: AI Code Improvement

on:
  repository_dispatch:
    types: [ai-code-improvement]

concurrency:
  group: ai-improvements
  cancel-in-progress: false

jobs:
  improve-code:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.PERSONAL_ACCESS_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run database migration
        env:
          POSTGRES_URL: ${{ secrets.POSTGRES_URL }}
        run: node scripts/run-migration.js || echo "Migration may have already run"

      - name: Install Claude Code CLI
        run: |
          curl -fsSL https://claude.ai/install.sh | bash
          echo "$HOME/.claude/bin" >> $GITHUB_PATH

      - name: Verify Claude Code installation
        run: |
          export PATH="$HOME/.claude/bin:$PATH"
          claude --version

      - name: Run Claude Code improvement
        id: claude
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          ORDER_ID: ${{ github.event.client_payload.order_id }}
        run: |
          export PATH="$HOME/.claude/bin:$PATH"

          # Run Claude Code with our instructions
          claude -p "Make a dramatic visual improvement to The Perfect Snake game. Follow the instructions in .claude/CLAUDE.md carefully. After completing successfully, write deployment metadata to public/deployment-metadata.json" \
            --allowedTools "Read,Write,Edit,Bash(npm run build),Bash(npm test -- --passWithNoTests)" \
            --max-turns 25 \
            --max-budget-usd 5.00 \
            --output-format json \
            --model claude-haiku-4-5-20251001 \
            --no-session-persistence \
            > claude-output.json

          # Display result
          echo "Claude Code result:"
          cat claude-output.json | jq -r '.result'

          # Calculate cost as if using API directly (input + output tokens only, no caching overhead)
          # Using model pricing: Haiku 4.5 = $1.00/MTok input, $5.00/MTok output
          input_tokens=$(cat claude-output.json | jq -r '.modelUsage | .[].inputTokens // 0')
          output_tokens=$(cat claude-output.json | jq -r '.modelUsage | .[].outputTokens // 0')
          cost=$(echo "scale=6; ($input_tokens * 0.000001) + ($output_tokens * 0.000005)" | bc)

          # Show comparison
          claude_total=$(cat claude-output.json | jq -r '.total_cost_usd // 0')
          echo "Claude Code total cost: \$$claude_total (includes caching)"
          echo "Direct API cost (displayed): \$$cost (input + output only)"
          echo "cost=$cost" >> $GITHUB_OUTPUT

      - name: Update job status in database
        env:
          POSTGRES_URL: ${{ secrets.POSTGRES_URL }}
          ORDER_ID: ${{ github.event.client_payload.order_id }}
          TOTAL_COST: ${{ steps.claude.outputs.cost }}
        run: node scripts/update-job-status.js

      - name: Check for changes
        id: check_changes
        run: |
          if [[ -n $(git status --porcelain) ]]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Commit and push changes
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          git config --global user.name "AI Code Improver"
          git config --global user.email "ai-improver@the-perfect-snake.app"
          git add .
          git commit -m "AI improvement from payment ${{ github.event.client_payload.order_id }}

          Co-Authored-By: Claude Code <noreply@anthropic.com>"
          git push origin main

      - name: No changes to commit
        if: steps.check_changes.outputs.has_changes == 'false'
        run: echo "No changes were made by the AI improvement"
